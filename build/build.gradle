task runChatGPT() {
        def postBody = new groovy.json.JsonBuilder()
                postBody messages: [
                        (
                                role: 'user',
                                content: ("Please review the commit " + commitUrl)
                        )
                        ]
                         model: 'gpt-3.5-turbo'

                def post = new URL("https://api.openai.com/v1/chat/completions").openConnection();
                post.setRequestMethod("POST")
                post.setDoOutput(true)
                post.setRequestProperty("Content-Type", "application/json")
                post.setRequestProperty("Authorization", "Bearer " + System.getenv('OPENAI_API_KEY'))
                post.getOutputStream().write(postBody.toString().getBytes("UTF-8"));
        
        doLast {
                def response = post.getInputStream().getText()
                println(response);
                response = response.takeBetween("\"choices\":[{\"text\":\"\\n\\n", '\"', 0)
                
                file("${projectDir}/../cr/" + commitMessage + ".txt").text = response
                println(response);
        }
}

defaultTasks 'runChatGPT'
